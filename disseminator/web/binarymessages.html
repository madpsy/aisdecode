<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIS Latest Messages Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .error { color: red; font-weight: bold; }
    .message { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; }
    .title { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.3rem; }
    .ts { font-size: 0.9rem; color: #555; margin-bottom: 0.8rem; }
    .table-container { overflow-x: auto; }
    table {
      border-collapse: collapse;
      table-layout: auto;
      margin-top: 0.5rem;
      white-space: nowrap;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.4rem 0.6rem;
      text-align: left;
      vertical-align: top;
    }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

<h1 id="main-title">Loading vessel…</h1>
<div id="output">Loading messages…</div>

<script>
// Utility: get numeric UserID from query string
function getUserID() {
  const p = new URLSearchParams(window.location.search);
  const v = p.get('UserID');
  return v && /^\d+$/.test(v) ? v : null;
}

// Flatten nested object
function flattenObject(obj, parentKey = '', res = {}) {
  for (const [k, v] of Object.entries(obj)) {
    const nk = parentKey ? `${parentKey}.${k}` : k;
    if (v !== null && typeof v === 'object' && !Array.isArray(v)) {
      flattenObject(v, nk, res);
    } else {
      res[nk] = v;
    }
  }
  return res;
}

// Format values: numbers to max 4 decimals
function formatValue(val) {
  if (typeof val === 'number' && isFinite(val)) {
    return parseFloat(val.toFixed(4)).toString();
  }
  return String(val);
}

// Humanize field name: replace underscores and dots with spaces
function humanizeField(field) {
  return field.replace(/[_\.]/g, ' ');
}

// Build a two-column table from flat data
function makeTable(data) {
  const rows = Object.entries(data)
    .map(([f, val]) => {
      const displayField = humanizeField(f);
      const displayVal = formatValue(val);
      return `<tr><td>${displayField}</td><td>${displayVal}</td></tr>`;
    })
    .join('');

  const tbl = document.createElement('table');
  tbl.innerHTML = `
    <thead><tr><th>Field</th><th>Value</th></tr></thead>
    <tbody>${rows}</tbody>`;
  return tbl;
}

async function main() {
  const userID = getUserID();
  const titleEl = document.getElementById('main-title');
  const output = document.getElementById('output');

  if (!userID) {
    titleEl.textContent = 'Error';
    output.innerHTML = '<div class="error">Invalid or missing numeric UserID parameter.</div>';
    return;
  }

  // Fetch vessel summary
  let summary;
  try {
    const resp = await fetch(`https://ais.oarc.uk/summary?UserID=${userID}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    summary = await resp.json();
  } catch (err) {
    titleEl.textContent = 'Error';
    output.innerHTML = `<div class="error">Failed to load summary: ${err.message}</div>`;
    return;
  }

  const info = summary[userID] || {};
  const vesselName = info.Name && info.Name.trim() ? info.Name : userID;
  titleEl.textContent = `Latest Messages for ${vesselName}`;

  // Fetch asm.json
  let asm;
  try {
    const r = await fetch('asm.json');
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    asm = await r.json();
  } catch (err) {
    output.innerHTML = `<div class="error">Failed to load asm.json: ${err.message}</div>`;
    return;
  }

  // Fetch latest messages
  let data;
  try {
    const r2 = await fetch(`https://ais.oarc.uk/latestmessages?UserID=${userID}`);
    if (r2.status !== 200) {
      output.innerHTML = '<div class="error">Vessel Not Found</div>';
      return;
    }
    data = await r2.json();
  } catch (err) {
    output.innerHTML = `<div class="error">Fetch error: ${err.message}</div>`;
    return;
  }

  // Filter & render
  const msgs = data.filter(m => m.Packet && m.Packet.DecodedBinary);
  if (!msgs.length) {
    output.innerHTML = '<div>No decoded-binary messages available.</div>';
    return;
  }
  output.innerHTML = '';

  msgs.forEach(msg => {
    const { MessageID, Timestamp, Packet } = msg;
    const { ApplicationID, DecodedBinary } = Packet;
    const dac = String(ApplicationID.DesignatedAreaCode);
    const fi = String(ApplicationID.FunctionIdentifier);

    let title = 'Unknown message type';
    if (asm[String(MessageID)]?.[dac]?.[fi]?.Title) {
      title = asm[String(MessageID)][dac][fi].Title;
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'message';

    const h = document.createElement('div');
    h.className = 'title';
    h.textContent = title;
    wrapper.appendChild(h);

    const localTs = new Date(Timestamp).toLocaleString();
    const ts = document.createElement('div');
    ts.className = 'ts';
    ts.textContent = `${localTs}`;
    wrapper.appendChild(ts);

    const flat = flattenObject(DecodedBinary);
    const tableContainer = document.createElement('div');
    tableContainer.className = 'table-container';
    tableContainer.appendChild(makeTable(flat));
    wrapper.appendChild(tableContainer);

    output.appendChild(wrapper);
  });
}

main();
</script>

</body>
</html>
