<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIS Latest Messages Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .error { color: red; font-weight: bold; }
    .message { position: relative; margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; }
    .title { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.3rem; }
    .ts { font-size: 0.9rem; color: #555; margin-bottom: 0.8rem; }
    .nav { position: absolute; top: 1rem; right: 1rem; }
    .nav button { background: none; border: none; font-size: 1.2rem; margin-left: 0.5rem; cursor: pointer; }
    .nav button:disabled { color: #bbb; cursor: default; }
    .table-container { overflow-x: auto; }
    table {
      border-collapse: collapse;
      table-layout: auto;
      margin-top: 0.5rem;
      white-space: nowrap;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.4rem 0.6rem;
      text-align: left;
      vertical-align: top;
    }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

<h1 id="main-title">Loading vessel…</h1>
<div id="output">Loading messages…</div>

<script>
  function getUserID() {
    const p = new URLSearchParams(window.location.search);
    const v = p.get('UserID');
    return v && /^\d+$/.test(v) ? v : null;
  }
  function flattenObject(obj, parentKey = '', res = {}) {
    for (const [k, v] of Object.entries(obj)) {
      const nk = parentKey ? `${parentKey}.${k}` : k;
      if (v !== null && typeof v === 'object' && !Array.isArray(v)) {
        flattenObject(v, nk, res);
      } else {
        res[nk] = v;
      }
    }
    return res;
  }
  function formatValue(val) {
    if (typeof val === 'number' && isFinite(val)) {
      return parseFloat(val.toFixed(4)).toString();
    }
    return String(val);
  }
  function humanizeField(field) {
    return field.replace(/[_\.]/g, ' ');
  }
  function makeTableHTML(data) {
    return `
      <table>
        <thead><tr><th>Field</th><th>Value</th></tr></thead>
        <tbody>
          ${Object.entries(data).map(([f, v]) =>
            `<tr><td>${humanizeField(f)}</td><td>${formatValue(v)}</td></tr>`
          ).join('')}
        </tbody>
      </table>`;
  }

  async function main() {
    const userID = getUserID();
    const titleEl = document.getElementById('main-title');
    const output = document.getElementById('output');
    if (!userID) {
      titleEl.textContent = 'Error';
      output.innerHTML = '<div class="error">Invalid or missing numeric UserID parameter.</div>';
      return;
    }

    // 1) summary
    let summary;
    try {
      const r = await fetch(`https://ais.oarc.uk/summary?UserID=${userID}`);
      if (!r.ok) throw '';
      summary = await r.json();
    } catch {
      titleEl.textContent = 'Error';
      output.innerHTML = '<div class="error">Failed to load summary</div>';
      return;
    }
    const info = summary[userID] || {};
    const vesselName = info.Name?.trim() ? info.Name : userID;
    titleEl.textContent = `Latest Messages for ${vesselName}`;

    // 2) asm.json
    let asm;
    try {
      const r = await fetch('asm.json'); if (!r.ok) throw '';
      asm = await r.json();
    } catch {
      output.innerHTML = '<div class="error">Failed to load asm.json</div>';
      return;
    }

    // 3) initial messages
    let messages;
    try {
      const r = await fetch(`https://ais.oarc.uk/latestmessages?UserID=${userID}`);
      if (r.status !== 200) throw '';
      messages = await r.json();
    } catch {
      output.innerHTML = '<div class="error">Vessel Not Found</div>';
      return;
    }

    const decoded = messages.filter(m => m.Packet?.DecodedBinary);
    if (!decoded.length) {
      output.innerHTML = '<div>No decoded-binary messages available.</div>';
      return;
    }
    output.innerHTML = '';

    decoded.forEach(msg => renderMessage(msg, userID, asm));
  }

  function renderMessage(msg, userID, asm) {
    const container = document.createElement('div');
    container.className = 'message';

    // Title
    const dac = msg.Packet.ApplicationID.DesignatedAreaCode;
    const fi = msg.Packet.ApplicationID.FunctionIdentifier;
    const msgTitle = asm[msg.MessageID]?.[dac]?.[fi]?.Title || 'Unknown message type';
    const h = document.createElement('div');
    h.className = 'title';
    h.textContent = msgTitle;
    container.appendChild(h);

    // Nav
    const nav = document.createElement('div');
    nav.className = 'nav';
    const btnNewer = document.createElement('button');
    btnNewer.textContent = '◀️';
    const btnOlder = document.createElement('button');
    btnOlder.textContent = '▶️';
    nav.appendChild(btnNewer);
    nav.appendChild(btnOlder);
    container.appendChild(nav);

    // Timestamp
    const tsDiv = document.createElement('div');
    tsDiv.className = 'ts';
    tsDiv.textContent = new Date(msg.Timestamp).toLocaleString();
    container.appendChild(tsDiv);

    // Table container
    const tableContainer = document.createElement('div');
    tableContainer.className = 'table-container';
    tableContainer.innerHTML = makeTableHTML(flattenObject(msg.Packet.DecodedBinary));
    container.appendChild(tableContainer);

    // Paging state
    let history = [ msg ];
    let idx = 0;
    btnNewer.disabled = true;

    btnNewer.addEventListener('click', () => {
      if (idx > 0) {
        idx--;
        refresh();
      }
    });

    btnOlder.addEventListener('click', async () => {
      // next in history?
      if (idx < history.length - 1) {
        idx++;
        refresh();
        return;
      }
      // fetch older batch
      const curID = history[idx].MessageID;
      const resp = await fetch(
        `https://ais.oarc.uk/latestmessages?UserID=${userID}&MessageID=${curID}&limit=10`
      );
      if (!resp.ok) return;
      const arr = await resp.json();
      const older = arr.filter(m => m.Packet?.DecodedBinary)
                       .filter(m => new Date(m.Timestamp) < new Date(history[idx].Timestamp));
      if (!older.length) {
        btnOlder.disabled = true;
        return;
      }
      history.push(older[0]);
      idx++;
      refresh();
    });

    function refresh() {
      const m = history[idx];
      tsDiv.textContent = new Date(m.Timestamp).toLocaleString();
      tableContainer.innerHTML = makeTableHTML(flattenObject(m.Packet.DecodedBinary));
      btnNewer.disabled = (idx === 0);
      // disable older if we've got 10 and at end
      btnOlder.disabled = history.length >= 10 && idx === history.length - 1;
    }

    document.getElementById('output').appendChild(container);
  }

  main();
</script>

</body>
</html>
