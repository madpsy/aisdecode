<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AIS Latest Messages Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .error { color: red; font-weight: bold; }
    .message { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; }
    .title { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; }
    th, td { border: 1px solid #ccc; padding: 0.4rem 0.6rem; text-align: left; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

<h1>AIS Latest Messages</h1>
<div id="output">Loading…</div>

<script>
// Utility: get numeric UserID from query string
function getUserID() {
  const params = new URLSearchParams(window.location.search);
  const uid = params.get('UserID');
  return uid && /^\d+$/.test(uid) ? uid : null;
}

// Recursively flatten an object, prefixing nested keys with parentKey + '.'
function flattenObject(obj, parentKey = '', result = {}) {
  for (const [key, value] of Object.entries(obj)) {
    const newKey = parentKey ? `${parentKey}.${key}` : key;
    if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
      flattenObject(value, newKey, result);
    } else {
      result[newKey] = value;
    }
  }
  return result;
}

// Given a flat object, return an HTML table element
function makeTable(flatData) {
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr><th>Field</th><th>Value</th></tr>`;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  for (const [field, val] of Object.entries(flatData)) {
    const tr = document.createElement('tr');
    const tdKey = document.createElement('td');
    tdKey.textContent = field;
    const tdVal = document.createElement('td');
    tdVal.textContent = String(val);
    tr.appendChild(tdKey);
    tr.appendChild(tdVal);
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  return table;
}

async function main() {
  const output = document.getElementById('output');
  const userID = getUserID();
  if (!userID) {
    output.innerHTML = '<div class="error">Invalid or missing numeric UserID parameter.</div>';
    return;
  }

  // Fetch asm.json
  let asm;
  try {
    const asmResp = await fetch('asm.json');
    if (!asmResp.ok) throw new Error(`HTTP ${asmResp.status}`);
    asm = await asmResp.json();
  } catch (err) {
    output.innerHTML = `<div class="error">Failed to load asm.json: ${err.message}</div>`;
    return;
  }

  // Fetch latestmessages
  const url = `https://ais.oarc.uk/latestmessages?UserID=${userID}`;
  let resp;
  try {
    resp = await fetch(url);
  } catch (err) {
    output.innerHTML = `<div class="error">Fetch error: ${err.message}</div>`;
    return;
  }
  if (resp.status !== 200) {
    output.innerHTML = '<div class="error">Vessel Not Found</div>';
    return;
  }

  let data;
  try {
    data = await resp.json();
  } catch (err) {
    output.innerHTML = `<div class="error">Invalid JSON response.</div>`;
    return;
  }

  // Only messages with DecodedBinary
  const withDecoded = data.filter(msg => msg.Packet && msg.Packet.DecodedBinary);
  if (withDecoded.length === 0) {
    output.innerHTML = '<div>No messages with DecodedBinary found.</div>';
    return;
  }
  output.innerHTML = ''; // clear

  // Render each
  withDecoded.forEach(msg => {
    const { MessageID, Packet } = msg;
    const { ApplicationID, DecodedBinary } = Packet;
    const dac = String(ApplicationID.DesignatedAreaCode);
    const fi = String(ApplicationID.FunctionIdentifier);

    // Lookup Title
    let title = 'Unknown message type';
    if (asm[String(MessageID)]?.[dac]?.[fi]?.Title) {
      title = asm[String(MessageID)][dac][fi].Title;
    }

    const container = document.createElement('div');
    container.className = 'message';
    const header = document.createElement('div');
    header.className = 'title';
    header.textContent = `MessageID ${MessageID} — ${title}`;
    container.appendChild(header);

    // Flatten and build table
    const flat = flattenObject(DecodedBinary);
    const table = makeTable(flat);
    container.appendChild(table);

    output.appendChild(container);
  });
}

main();
</script>

</body>
</html>
