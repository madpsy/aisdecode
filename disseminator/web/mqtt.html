<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Raw Sentences by Receiver</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: monospace;
            background-color: #f5f5f5;
        }
        .message {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }
        .message:nth-child(odd) {
            background-color: #f9f9f9;
        }
        .timestamp {
            color: #666;
            font-size: 0.8em;
            display: inline-block;
            margin-right: 10px;
            min-width: 80px;
        }
        .status {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        h1 {
            color: #333;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
    </style>
</head>
<body>
    <h1>MQTT Raw Sentences by Receiver</h1>
    
    <div id="statusDisplay" class="status connecting">Connecting to MQTT broker...</div>
    
    <div class="controls">
        <button id="clearMessages">Clear Messages</button>
    </div>
    
    <div id="messages"></div>

    <script>
        // Get receiver ID from query parameter or default to 0
        const urlParams = new URLSearchParams(window.location.search);
        let receiverId = parseInt(urlParams.get('receiver') || '0', 10);
        
        // MQTT connection settings
        let mqttHost = '';
        let mqttPort = 0;
        let mqttTopic = '';
        let client = null;
        let currentSubscription = null;
        let receiversMap = {}; // Map of receiver IDs to receiver names
        
        // Fetch receivers data from the server
        async function fetchReceivers() {
            try {
                const response = await fetch('/receivers');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const receivers = await response.json();
                
                // Create a map of receiver IDs to names
                receivers.forEach(receiver => {
                    receiversMap[receiver.id] = receiver.name;
                });
                
                console.log('Fetched receivers:', receiversMap);
                
                // After fetching receivers, get MQTT config
                fetchMQTTConfig();
            } catch (error) {
                updateStatus('disconnected', `Failed to fetch receivers: ${error.message}`);
                console.error('Error fetching receivers:', error);
            }
        }
        
        // Fetch MQTT configuration from the server
        async function fetchMQTTConfig() {
            try {
                const response = await fetch('/mqtt');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const config = await response.json();
                mqttHost = config.mqtt_host;
                mqttPort = config.mqtt_port;
                mqttTopic = config.mqtt_topic;
                updateStatus('connecting', `Fetched MQTT config: ${mqttHost}:${mqttPort}`);
                
                // Now that we have the config, connect to MQTT
                connectMQTT();
            } catch (error) {
                updateStatus('disconnected', `Failed to fetch MQTT config: ${error.message}`);
                console.error('Error fetching MQTT config:', error);
            }
        }
        
        // Message display element
        const messagesDiv = document.getElementById('messages');
        const statusDisplay = document.getElementById('statusDisplay');
        
        // Connect to MQTT broker
        function connectMQTT() {
            updateStatus('connecting', `Connecting to MQTT broker at ${mqttHost}:${mqttPort}...`);
            
            // Create MQTT client
            const serverUrl = `wss://${mqttHost}:${mqttPort}`;
            client = mqtt.connect(serverUrl, {
                clientId: 'web_client_' + Math.random().toString(16).substr(2, 8),
                clean: true
            });
            
            // Handle connection events
            client.on('connect', function() {
                updateStatus('connected', 'Connected to MQTT broker');
                subscribeToReceiver(receiverId);
            });
            
            client.on('error', function(error) {
                updateStatus('disconnected', 'Connection error: ' + error.message);
                console.error('MQTT error:', error);
            });
            
            client.on('offline', function() {
                updateStatus('disconnected', 'Disconnected from MQTT broker');
            });
            
            client.on('message', function(topic, message) {
                try {
                    const payload = JSON.parse(message.toString());
                    if (payload.raw_sentence) {
                        addMessage(payload.raw_sentence, payload.timestamp);
                    }
                } catch (e) {
                    console.error('Error parsing message:', e);
                    addMessage('Error parsing message: ' + e.message);
                }
            });
        }
        
        // Subscribe to messages for a specific receiver
        function subscribeToReceiver(id) {
            if (!client || !client.connected) {
                updateStatus('disconnected', 'Not connected to MQTT broker');
                return;
            }
            
            // Unsubscribe from previous topic if any
            if (currentSubscription) {
                client.unsubscribe(currentSubscription);
            }
            
            // Subscribe to all messages for this receiver ID
            // The + wildcards match any shard_id, user_id, and message_id
            const topic = `${mqttTopic}/+/+/${id}/+/message`;
            client.subscribe(topic, function(err) {
                if (err) {
                    updateStatus('disconnected', 'Failed to subscribe: ' + err.message);
                    console.error('Subscription error:', err);
                } else {
                    const receiverName = receiversMap[id] || `Unknown (ID: ${id})`;
                    updateStatus('connected', `Subscribed to receiver: ${receiverName}`);
                    currentSubscription = topic;
                    
                    // Update URL without reloading the page
                    const url = new URL(window.location);
                    url.searchParams.set('receiver', id);
                    window.history.pushState({}, '', url);
                }
            });
        }
        
        // Add a message to the display
        function addMessage(message, timestamp = null) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            if (timestamp) {
                const timeElement = document.createElement('span');
                timeElement.className = 'timestamp';
                timeElement.textContent = new Date(timestamp).toLocaleTimeString();
                messageElement.appendChild(timeElement);
            }
            
            const contentElement = document.createElement('span');
            contentElement.textContent = message;
            messageElement.appendChild(contentElement);
            
            // Insert at the beginning (newest at top)
            messagesDiv.insertBefore(messageElement, messagesDiv.firstChild);
            messagesDiv.scrollTop = 0;
        }
        
        // Update connection status display
        function updateStatus(status, message) {
            statusDisplay.className = `status ${status}`;
            statusDisplay.textContent = message;
        }
        
        // Event listeners
        document.getElementById('clearMessages').addEventListener('click', function() {
            messagesDiv.innerHTML = '';
        });
        
        // Initialize by fetching receivers first, then MQTT config
        fetchReceivers();
    </script>
</body>
</html>