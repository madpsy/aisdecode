<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIS Message History Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .error { color: red; font-weight: bold; }

    h1 { font-size: 1.6rem; margin-bottom: 0.2rem; }
    h2 { font-size: 1rem; color: #555; margin-top: 0; margin-bottom: 0.6rem; }

    .type-selector { margin-bottom: 1.2rem; }
    .date-row, .fields-row, .button-row {
      display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.6rem;
      font-size: 0.9rem;
    }
    .date-row label, .fields-row label {
      display: flex; flex-direction: column; flex: 1 1 150px;
    }
    .button-row button {
      background: none; border: 1px solid #ccc;
      font-size: 1.2rem; cursor: pointer; padding: 0.4rem 0.8rem;
      border-radius: 4px; transition: background 0.2s;
    }
    .button-row button:hover { background: #f0f0f0; }
    .button-row button:disabled { color: #bbb; cursor: default; opacity: 0.4; }

    .download-row, .pagination-row {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
    }
    .download-row button {
      background: none; border: 1px solid #ccc;
      padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer;
      font-size: 1.2rem; transition: background 0.2s;
    }
    .download-row button:hover { background: #f0f0f0; }

    .pagination-row select, .pagination-row button {
      font-size: 1rem; padding: 0.3rem; cursor: pointer;
    }
    .pagination-row button {
      border: 1px solid #ccc; background: none; border-radius: 4px;
    }
    .pagination-row button:disabled { color: #bbb; cursor: default; opacity: 0.4; }

    .nav { display: flex; align-items: center; margin-bottom: 0.8rem; }
    .nav button {
      background: none; border: none;
      font-size: 1.2rem; margin: 0 0.3rem;
      cursor: pointer; transition: opacity 0.2s;
    }
    .nav button:disabled { color: #bbb; cursor: default; opacity: 0.4; }
    .nav .counter { font-size: 0.9rem; color: #333; min-width: 3em; text-align: center; }

    table {
      border-collapse: collapse; table-layout: auto;
      white-space: nowrap; width: 100%;
    }
    th, td {
      border: 1px solid #ccc; padding: 0.4rem 0.6rem;
      text-align: left; vertical-align: top;
    }
    th { background: #f0f0f0; }

    .raw-sentence {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1 id="main-title">Loading…</h1>
  <h2 id="sub-title"></h2>
  <div id="error" class="error"></div>

  <!-- Message type -->
  <div class="type-selector" id="type-selector" style="display:none;">
    <label>Message Type:
      <select id="message-type-select"></select>
    </label>
  </div>

  <!-- Date row -->
  <div class="date-row">
    <label>From <input type="datetime-local" id="start"/></label>
    <label>To   <input type="datetime-local" id="end"/></label>
  </div>

  <!-- Fields -->
  <div class="fields-row">
    <label>Fields
      <select multiple size="4" id="fields"></select>
    </label>
  </div>

  <!-- Show/Reset -->
  <div class="button-row">
    <button id="apply">Show Range</button>
    <button id="reset">Reset</button>
  </div>

  <!-- Download CSV -->
  <div class="download-row" id="download-row" style="display:none;">
    <button id="download-csv">Download CSV</button>
    <label><input type="checkbox" id="include-raw" checked/> Include RawSentence</label>
  </div>

  <!-- Pagination info + controls -->
  <div class="pagination-row" id="pagination-row" style="display:none;">
    <span id="view-info"></span>
    <label>Rows:
      <select id="rows-per-page">
        <option>10</option>
        <option>25</option>
        <option>50</option>
        <option>100</option>
      </select>
    </label>
    <button id="page-prev">Prev</button>
    <button id="page-next">Next</button>
  </div>

  <!-- Individual view -->
  <div id="individual-view">
    <div class="nav">
      <button id="prev">◀️</button>
      <div class="counter" id="counter">0 of 0</div>
      <button id="next">▶️</button>
    </div>
    <div id="single-table"></div>
    <div class="raw-sentence" id="single-raw"></div>
  </div>

  <!-- Range view -->
  <div id="range-view" style="display:none;">
    <div id="range-table"></div>
  </div>

  <script>
    // Helpers…
    function qsParam(n){ const v=new URLSearchParams(location.search).get(n); return v&&/^\d+$/.test(v)?v:null; }
    function setSearch(p){ const u=new URL(location); u.search=p.toString(); location=u; }
    function flatten(o,p='',r={}){ for(const[k,v] of Object.entries(o||{})){ const key=p?`${p}.${k}`:k; if(v!=null&&typeof v==='object'&&!Array.isArray(v)) flatten(v,key,r); else r[key]=v;} return r;}
    function humanize(f){ return f.replace(/[_\.]/g,' '); }
    function makeSingle(m){
      const f=flatten(m.Packet);
      let h='<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
      Object.keys(f).sort().forEach(k=>h+=`<tr><td>${humanize(k)}</td><td>${f[k]}</td></tr>`);
      return h+'</tbody></table>';
    }
    function makeRange(rows,fields){
      let h='<table><thead><tr><th>Timestamp</th>';
      fields.forEach(f=>h+=`<th>${humanize(f)}</th>`);
      h+='<th>Sentences</th></tr></thead><tbody>';
      rows.forEach((r,i)=>{
        const f=flatten(r.Packet);
        h+='<tr>';
        h+=`<td>${new Date(r.Timestamp).toLocaleString([],{hour12:false})}</td>`;
        fields.forEach(c=>h+=`<td>${f[c]!=null?f[c]:''}</td>`);
        h+=`<td><button class="view" data-i="${i}">View</button></td></tr>`;
      });
      return h+'</tbody></table>';
    }
    function toCSV(rows,fields,inc){
      const hdr=['Timestamp',...fields]; if(inc) hdr.push('RawSentence');
      const L=[hdr.join(',')];
      rows.forEach(r=>{
        const f=flatten(r.Packet),ts=new Date(r.Timestamp).toISOString();
        const vals=fields.map(c=>{
          const v=f[c]; return v!=null?`"${String(v).replace(/"/g,'""')}"`:'';
        });
        if(inc){
          const raw=`"${r.RawSentence.replace(/"/g,'""')}"`;
          L.push([ts,...vals,raw].join(','));
        } else L.push([ts,...vals].join(','));
      });
      return L.join('\n');
    }

    (async()=>{
      const userID=qsParam('UserID'), msgID=qsParam('MessageID'),
            err=document.getElementById('error'),
            mainT=document.getElementById('main-title'),
            subT=document.getElementById('sub-title'),
            tsDiv=document.getElementById('type-selector'),
            tsSel=document.getElementById('message-type-select'),
            downloadRow=document.getElementById('download-row'),
            dlBtn=document.getElementById('download-csv'),
            incRaw=document.getElementById('include-raw'),
            paginationRow=document.getElementById('pagination-row'),
            viewInfo=document.getElementById('view-info'),
            rowsPerPageSel=document.getElementById('rows-per-page'),
            pagePrev=document.getElementById('page-prev'),
            pageNext=document.getElementById('page-next'),
            rangeTable=document.getElementById('range-table'),
            individualView=document.getElementById('individual-view'),
            rangeView=document.getElementById('range-view');

      if(!userID){ mainT.textContent='Error'; err.textContent='Missing UserID.'; return; }
      // Vessel name
      try{ const r=await fetch(`/summary?UserID=${userID}`,{cache:'no-store'}),s=await r.json();
        mainT.textContent=`Latest Messages for ${s[userID]?.Name.trim()||userID}`; }
      catch{ mainT.textContent=`Latest Messages for ${userID}`; }

      // Types
      let avail=[];
      try{ const r=await fetch(`/state/${userID}`,{cache:'no-store'}),st=await r.json();
        avail=st.MessageTypes||[]; }
      catch{}
      let map={};
      try{ map=await(await fetch('/message_types.json',{cache:'no-store'})).json(); }
      catch{}
      avail.forEach(t=>{
        const o=document.createElement('option');
        o.value=t; o.textContent=`${map[t]||'Msg '+t} (ID ${t})`;
        if(String(t)===msgID) o.selected=true;
        tsSel.append(o);
      });
      if(avail.length){
        tsDiv.style.display='';
        tsSel.onchange=()=>{ setSearch(new URLSearchParams({UserID:userID,MessageID:tsSel.value})); };
      }
      if(msgID) subT.textContent=`${map[msgID]||('Message '+msgID)} (ID ${msgID})`;

      // Fetch up to 2000
      const base=`/latestmessages?UserID=${userID}&MessageID=${msgID}`;
      let all=[];
      try{ all=await(await fetch(`${base}&limit=2000`,{cache:'no-store'})).json(); }
      catch{ err.textContent='Failed to load messages.'; return; }
      if(!all.length){ err.textContent='No messages found.'; return; }

      // Fields
      const f0=flatten(all[0].Packet),
            numeric=Object.entries(f0).filter(([,v])=>typeof v==='number').map(([k])=>k).sort(),
            fieldsSel=document.getElementById('fields');
      numeric.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=humanize(c); fieldsSel.append(o); });

      // Individual view logic (unchanged)…
      // …

      // Range & pagination state
      let rangeData=[], currentPage=1, rowsPerPage=10;
      function renderPage(){
        const start=(currentPage-1)*rowsPerPage,
              end=Math.min(rangeData.length,start+rowsPerPage),
              pageRows=rangeData.slice(start,end);
        rangeTable.innerHTML=makeRangeHTML(pageRows,numericSelected);
        viewInfo.textContent=`Viewing ${start+1}–${end} of ${rangeData.length}`;
        pagePrev.disabled=currentPage===1;
        pageNext.disabled=end===rangeData.length;
        rangeTable.querySelectorAll('button.view').forEach(btn=>
          btn.onclick=()=>alert(rangeData[btn.dataset.i%rowsPerPage].RawSentence)
        );
      }
      rowsPerPageSel.onchange=()=>{
        rowsPerPage=parseInt(rowsPerPageSel.value,10);
        currentPage=1; renderPage();
      };
      pagePrev.onclick=()=>{
        if(currentPage>1){ currentPage--; renderPage(); }
      };
      pageNext.onclick=()=>{
        if(currentPage*rowsPerPage<rangeData.length){ currentPage++; renderPage(); }
      };

      document.getElementById('apply').onclick=async()=>{
        const s=document.getElementById('start').value,
              e=document.getElementById('end').value,
              numericSelected=Array.from(fieldsSel.selectedOptions).map(o=>o.value);
        if(!s||!e||!numericSelected.length){
          return alert('Select From, To & at least one field.');
        }
        const p=new URLSearchParams({
          UserID:userID,MessageID:msgID,
          start:new Date(s).toISOString(),
          end:new Date(e).toISOString(),
          limit:'2000'
        });
        try{ rangeData=await(await fetch(`${base}&${p}`,{cache:'no-store'})).json(); }
        catch{ return alert('Failed to fetch range.'); }
        downloadBtn.onclick=()=>{
          const csv=toCSV(rangeData,numericSelected,incRaw.checked),
                b=new Blob([csv],{type:'text/csv'}),
                u=URL.createObjectURL(b),
                a=document.createElement('a');
          a.href=u; a.download=`messages_${userID}_${msgID}.csv`;
          a.click(); URL.revokeObjectURL(u);
        };
        downloadRow.style.display='';
        paginationRow.style.display='';
        individualView.style.display='none';
        rangeView.style.display='';
        renderPage();
      };
      document.getElementById('reset').onclick=()=>{
        document.getElementById('start').value='';
        document.getElementById('end').value='';
        fieldsSel.selectedIndex=-1;
        downloadRow.style.display='none';
        paginationRow.style.display='none';
        rangeView.style.display='none';
        individualView.style.display='';
      };
    })();
  </script>
</body>
</html>
