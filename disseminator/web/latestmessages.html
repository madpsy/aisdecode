<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIS Message History Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .error { color: red; font-weight: bold; }

    h1 { font-size: 1.6rem; margin-bottom: 0.2rem; }
    h2 { font-size: 1rem; color: #555; margin-top: 0; margin-bottom: 0.6rem; }

    .type-selector { margin-bottom: 1.2rem; }
    .type-selector select { font-size: 1rem; padding: 0.3rem; }

    .date-row, .fields-row, .button-row {
      display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.6rem;
      font-size: 0.9rem;
    }
    .date-row label, .fields-row label {
      display: flex; flex-direction: column; flex: 1 1 150px;
    }
    .button-row button {
      background: none; border: 1px solid #ccc;
      font-size: 1.2rem; cursor: pointer; padding: 0.4rem 0.8rem;
      border-radius: 4px; transition: background 0.2s;
    }
    .button-row button:hover { background: #f0f0f0; }
    .button-row button:disabled { color: #bbb; cursor: default; opacity: 0.4; }

    .download-row, .pagination-row {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
    }
    .download-row button {
      background: none; border: 1px solid #ccc;
      padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer;
      font-size: 1.2rem; transition: background 0.2s;
    }
    .download-row button:hover { background: #f0f0f0; }

    .pagination-row select, .pagination-row button {
      font-size: 1rem; padding: 0.3rem; cursor: pointer;
    }
    .pagination-row button {
      border: 1px solid #ccc; background: none; border-radius: 4px;
    }
    .pagination-row button:disabled { color: #bbb; cursor: default; opacity: 0.4; }

    .nav { display: flex; align-items: center; margin-bottom: 0.8rem; }
    .nav button {
      background: none; border: none;
      font-size: 1.2rem; margin: 0 0.3rem;
      cursor: pointer; transition: opacity 0.2s;
    }
    .nav button:disabled { color: #bbb; cursor: default; opacity: 0.4; }
    .nav .counter { font-size: 0.9rem; color: #333; min-width: 3em; text-align: center; }

    table {
      border-collapse: collapse; table-layout: auto;
      white-space: nowrap; width: 100%;
    }
    th, td {
      border: 1px solid #ccc; padding: 0.4rem 0.6rem;
      text-align: left; vertical-align: top;
    }
    th { background: #f0f0f0; }

    .raw-sentence {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1 id="main-title">Loading…</h1>
  <h2 id="sub-title"></h2>
  <div id="error" class="error"></div>

  <div class="type-selector" id="type-selector" style="display:none;">
    <label>Message Type:
      <select id="message-type-select"></select>
    </label>
  </div>

  <div class="date-row">
    <label>From <input type="datetime-local" id="start"/></label>
    <label>To   <input type="datetime-local" id="end"/></label>
  </div>

  <div class="fields-row">
    <label>Fields
      <select multiple size="4" id="fields"></select>
    </label>
  </div>

  <div class="button-row">
    <button id="apply">Show Range</button>
    <button id="reset">Reset</button>
  </div>

  <div class="download-row" id="download-row" style="display:none;">
    <button id="download-csv">Download CSV</button>
    <label><input type="checkbox" id="include-raw" checked/> Include RawSentence</label>
  </div>

  <div class="pagination-row" id="pagination-row" style="display:none;">
    <span id="view-info"></span>
    <label>Rows:
      <select id="rows-per-page">
        <option>10</option>
        <option>25</option>
        <option>50</option>
        <option>100</option>
      </select>
    </label>
    <button id="page-prev">Prev</button>
    <button id="page-next">Next</button>
  </div>

  <div id="individual-view">
    <div class="nav">
      <button id="prev">◀️</button>
      <div class="counter" id="counter">0 of 0</div>
      <button id="next">▶️</button>
    </div>
    <div id="single-table"></div>
    <div class="raw-sentence" id="single-raw"></div>
  </div>

  <div id="range-view" style="display:none;">
    <div id="range-table"></div>
  </div>

  <script>
    // Read numeric query param
    function qsParam(name) {
      const v = new URLSearchParams(window.location.search).get(name);
      return v && /^\d+$/.test(v) ? v : null;
    }

    // Replace URL search and reload
    function setSearch(params) {
      const u = new URL(window.location.href);
      u.search = params.toString();
      window.location.href = u;
    }

    // Deep-flatten packet object
    function flatten(obj, prefix='', res={}) {
      for (const [k, v] of Object.entries(obj || {})) {
        const key = prefix ? `${prefix}.${k}` : k;
        if (v != null && typeof v === 'object' && !Array.isArray(v)) {
          flatten(v, key, res);
        } else {
          res[key] = v;
        }
      }
      return res;
    }

    // Turn snake.case to human text
    function humanize(field) {
      return field.replace(/[_\.]/g, ' ');
    }

    // Build HTML table for single message
    function makeSingleHTML(msg) {
      const flat = flatten(msg.Packet);
      let html = '<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
      Object.keys(flat).sort().forEach(k => {
        html += `<tr><td>${humanize(k)}</td><td>${flat[k]}</td></tr>`;
      });
      return html + '</tbody></table>';
    }

    // Build HTML table for a page of range
    function makeRangeHTML(rows, fields) {
      let html = '<table><thead><tr><th>Timestamp</th>';
      fields.forEach(f => {
        html += `<th>${humanize(f)}</th>`;
      });
      html += '<th>Sentences</th></tr></thead><tbody>';
      rows.forEach((r, i) => {
        const flat = flatten(r.Packet);
        html += '<tr>';
        html += `<td>${new Date(r.Timestamp).toLocaleString([], {hour12:false})}</td>`;
        fields.forEach(f => {
          html += `<td>${flat[f] != null ? flat[f] : ''}</td>`;
        });
        html += `<td><button class="view" data-i="${i}">View</button></td>`;
        html += '</tr>';
      });
      return html + '</tbody></table>';
    }

    // Generate CSV text
    function toCSV(rows, fields, includeRaw) {
      const header = ['Timestamp', ...fields];
      if (includeRaw) header.push('RawSentence');
      const lines = [header.join(',')];
      rows.forEach(r => {
        const flat = flatten(r.Packet);
        const ts = new Date(r.Timestamp).toISOString();
        const vals = fields.map(f => {
          const v = flat[f];
          return v != null ? `"${String(v).replace(/"/g,'""')}"` : '';
        });
        if (includeRaw) {
          const raw = `"${r.RawSentence.replace(/"/g,'""')}"`;
          lines.push([ts, ...vals, raw].join(','));
        } else {
          lines.push([ts, ...vals].join(','));
        }
      });
      return lines.join('\n');
    }

    (async () => {
      const userID = qsParam('UserID'),
            msgID  = qsParam('MessageID');

      const errorEl       = document.getElementById('error'),
            mainTitle     = document.getElementById('main-title'),
            subTitle      = document.getElementById('sub-title'),
            typeSelector  = document.getElementById('type-selector'),
            typeSelect    = document.getElementById('message-type-select'),
            startInput    = document.getElementById('start'),
            endInput      = document.getElementById('end'),
            fieldsSelect  = document.getElementById('fields'),
            applyBtn      = document.getElementById('apply'),
            resetBtn      = document.getElementById('reset'),
            downloadRow   = document.getElementById('download-row'),
            downloadBtn   = document.getElementById('download-csv'),
            includeRawChk = document.getElementById('include-raw'),
            paginationRow = document.getElementById('pagination-row'),
            viewInfo      = document.getElementById('view-info'),
            rowsPerPageSel= document.getElementById('rows-per-page'),
            pagePrevBtn   = document.getElementById('page-prev'),
            pageNextBtn   = document.getElementById('page-next'),
            individualDiv = document.getElementById('individual-view'),
            rangeDiv      = document.getElementById('range-view'),
            singleTable   = document.getElementById('single-table'),
            singleRaw     = document.getElementById('single-raw'),
            prevBtn       = document.getElementById('prev'),
            nextBtn       = document.getElementById('next'),
            counterDiv    = document.getElementById('counter'),
            rangeTable    = document.getElementById('range-table');

      if (!userID) {
        mainTitle.textContent = 'Error';
        errorEl.textContent = 'Missing UserID in URL.';
        return;
      }

      // Fetch vessel name
      try {
        const res = await fetch(`/summary?UserID=${userID}`, {cache:'no-store'});
        const summary = await res.json();
        const name = summary[userID]?.Name.trim() || userID;
        mainTitle.textContent = `Latest Messages for ${name}`;
      } catch {
        mainTitle.textContent = `Latest Messages for ${userID}`;
      }

      // Load available message types
      let available = [];
      try {
        const res = await fetch(`/state/${userID}`, {cache:'no-store'});
        const st = await res.json();
        available = st.MessageTypes || [];
      } catch {}

      // Load translation map
      let typeMap = {};
      try {
        typeMap = await (await fetch('/message_types.json', {cache:'no-store'})).json();
      } catch {}

      // Populate type dropdown
      available.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = `${typeMap[t] || 'Msg ' + t} (ID ${t})`;
        if (String(t) === msgID) opt.selected = true;
        typeSelect.append(opt);
      });
      if (available.length) {
        typeSelector.style.display = '';
        typeSelect.onchange = () => {
          const p = new URLSearchParams({UserID:userID, MessageID:typeSelect.value});
          setSearch(p);
        };
      }

      // Subtitle
      if (msgID) {
        subTitle.textContent = `${typeMap[msgID] || 'Message ' + msgID} (ID ${msgID})`;
      }

      // Fetch last 100 for individual view
      let allMsgs = [];
      try {
        allMsgs = await (await fetch(`/latestmessages?UserID=${userID}&MessageID=${msgID}&limit=100`, {cache:'no-store'})).json();
      } catch {
        errorEl.textContent = 'Failed to load messages.';
        return;
      }
      if (!allMsgs.length) {
        errorEl.textContent = 'No messages found.';
        return;
      }

      // Fill fields selector
      const firstFlat = flatten(allMsgs[0].Packet);
      const numericFields = Object.entries(firstFlat)
        .filter(([,v]) => typeof v === 'number')
        .map(([k]) => k)
        .sort();
      numericFields.forEach(f => {
        const o = document.createElement('option');
        o.value = f;
        o.textContent = humanize(f);
        fieldsSelect.append(o);
      });

      // Individual view pagination
      let idx = 0;
      function renderIndividual() {
        const msg = allMsgs[idx];
        counterDiv.textContent = `${idx+1} of ${allMsgs.length}`;
        singleTable.innerHTML = makeSingleHTML(msg);
        singleRaw.textContent = msg.RawSentence;
        prevBtn.disabled = idx === 0;
        nextBtn.disabled = idx === allMsgs.length - 1;
      }
      prevBtn.onclick = () => idx>0 && (--idx, renderIndividual());
      nextBtn.onclick = () => idx<allMsgs.length-1 && (++idx, renderIndividual());
      renderIndividual();

      // Range + Pagination state
      let rangeData = [];
      let currentPage = 1;
      let rowsPerPage = parseInt(rowsPerPageSel.value, 10);

      function renderPage() {
        const start = (currentPage - 1) * rowsPerPage;
        const end = Math.min(rangeData.length, start + rowsPerPage);
        const pageRows = rangeData.slice(start, end);
        rangeTable.innerHTML = makeRangeHTML(pageRows, numericFields);
        viewInfo.textContent = `Viewing ${start+1}–${end} of ${rangeData.length}`;
        pagePrevBtn.disabled = currentPage === 1;
        pageNextBtn.disabled = end === rangeData.length;
        rangeTable.querySelectorAll('button.view').forEach(btn => {
          const idxOnPage = parseInt(btn.dataset.i, 10);
          btn.onclick = () => alert(rangeData[(currentPage-1)*rowsPerPage + idxOnPage].RawSentence);
        });
      }

      rowsPerPageSel.onchange = () => {
        rowsPerPage = parseInt(rowsPerPageSel.value, 10);
        currentPage = 1;
        renderPage();
      };
      pagePrevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage();
        }
      };
      pageNextBtn.onclick = () => {
        if (currentPage * rowsPerPage < rangeData.length) {
          currentPage++;
          renderPage();
        }
      };

      // Show Range logic
      applyBtn.onclick = async () => {
        const s = startInput.value, e = endInput.value;
        const sel = Array.from(fieldsSelect.selectedOptions).map(o => o.value);
        if (!s || !e || !sel.length) {
          return alert('Please select From, To, and at least one field.');
        }

        const params = new URLSearchParams({
          UserID:    userID,
          MessageID: msgID,
          start:     new Date(s).toISOString(),
          end:       new Date(e).toISOString(),
          limit:     '2000'
        });

        try {
          rangeData = await (await fetch(`/latestmessages?${params}`, {cache:'no-store'})).json();
        } catch {
          return alert('Failed to fetch range.');
        }

        // CSV download logic
        downloadBtn.onclick = () => {
          const csv = toCSV(rangeData, sel, includeRawChk.checked);
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `messages_${userID}_${msgID}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        };

        downloadRow.style.display = '';
        paginationRow.style.display = '';
        individualDiv.style.display = 'none';
        rangeDiv.style.display = '';
        currentPage = 1;
        renderPage();
      };

      // Reset logic
      resetBtn.onclick = () => {
        startInput.value = '';
        endInput.value   = '';
        fieldsSelect.selectedIndex = -1;
        downloadRow.style.display = 'none';
        paginationRow.style.display = 'none';
        rangeDiv.style.display = 'none';
        individualDiv.style.display = '';
      };
    })();
  </script>
</body>
</html>
