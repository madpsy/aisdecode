<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIS Message History Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .error { color: red; font-weight: bold; }

    h1 { font-size: 1.6rem; margin-bottom: 0.2rem; }
    h2 { font-size: 1rem; color: #555; margin-top: 0; margin-bottom: 0.6rem; }

    .row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.6rem; font-size:0.9rem; }
    .row label { display: flex; flex-direction: column; flex:1 1 150px; }
    .row select, .row input { font-size:1rem; padding:0.3rem; }
    .button-row button {
      background:none;border:1px solid #ccc;border-radius:4px;
      padding:0.4rem 0.8rem;font-size:1.2rem;cursor:pointer;
      transition:background 0.2s;
    }
    .button-row button:hover { background:#f0f0f0; }
    .button-row button:disabled { color:#bbb;cursor:default;opacity:0.4; }

    .download-row, .pagination-row {
      display:flex;align-items:center;gap:1rem;margin-bottom:1rem;
    }
    .download-row button {
      background:none;border:1px solid #ccc;border-radius:4px;
      padding:0.4rem 0.8rem;font-size:1.2rem;cursor:pointer;
      transition:background 0.2s;
    }
    .download-row button:hover { background:#f0f0f0; }

    .pagination-row select, .pagination-row button {
      font-size:1rem;padding:0.3rem;cursor:pointer;
    }
    .pagination-row button {
      border:1px solid #ccc;border-radius:4px;background:none;
    }
    .pagination-row button:disabled { color:#bbb;cursor:default;opacity:0.4; }

    .nav { display:flex;align-items:center;margin-bottom:0.8rem; }
    .nav button {
      background:none;border:none;font-size:1.2rem;margin:0 0.3rem;
      cursor:pointer;transition:opacity .2s;
    }
    .nav button:disabled { color:#bbb;cursor:default;opacity:0.4; }
    .nav .counter { font-size:.9rem;color:#333;min-width:3em;text-align:center; }

    table {
      border-collapse:collapse;white-space:nowrap;width:100%;
    }
    th,td {
      border:1px solid #ccc;padding:.4rem .6rem;
      text-align:left;vertical-align:top;
    }
    th { background:#f0f0f0; }
    th.sortable { cursor:pointer; }
    th .arrow { margin-left:4px; font-size:0.8em; }

    .raw-sentence {
      margin-top:.5rem;padding:.5rem;
      background:#f9f9f9;border:1px solid #eee;border-radius:4px;
      font-family:monospace;white-space:pre-wrap;
    }

    #chart-container { position:relative;width:100%;height:400px;margin-bottom:1rem; }
  </style>

  <!-- Chart.js, date-fns adapter, and zoom plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>
<body>
  <h1 id="main-title">Loading…</h1>
  <h2 id="sub-title"></h2>
  <div id="error" class="error"></div>

  <div class="row" id="type-selector" style="display:none;">
    <label>Message Type:
      <select id="message-type-select"></select>
    </label>
  </div>

  <div class="row">
    <label>From <input type="datetime-local" id="start"/></label>
    <label>To   <input type="datetime-local" id="end"/></label>
  </div>

  <div class="row">
    <label>Fields
      <select multiple size="4" id="fields"></select>
    </label>
    <label>Results as
      <select id="results-as">
        <option value="table" selected>Table</option>
        <option value="graph">Graph</option>
      </select>
    </label>
  </div>

  <div class="button-row">
    <button id="apply">Search</button>
    <button id="reset">Reset</button>
  </div>

  <div class="download-row" id="download-row" style="display:none;">
    <button id="download-csv">Download CSV</button>
    <label><input type="checkbox" id="include-raw"/> Include Sentences</label>
  </div>

  <div class="pagination-row" id="pagination-row" style="display:none;">
    <span id="view-info"></span>
    <label>Rows:
      <select id="rows-per-page">
        <option>10</option>
        <option>25</option>
        <option>50</option>
        <option>100</option>
      </select>
    </label>
    <button id="page-prev">Prev</button>
    <button id="page-next">Next</button>
  </div>

  <div id="individual-view">
    <div class="nav">
      <button id="prev">◀️</button>
      <div class="counter" id="counter">0 of 0</div>
      <button id="next">▶️</button>
    </div>
    <div id="single-table"></div>
    <div class="raw-sentence" id="single-raw"></div>
  </div>

  <div id="range-view" style="display:none;">
    <div id="range-table"></div>
    <div id="chart-container" style="display:none;">
      <canvas id="range-chart"></canvas>
    </div>
  </div>

  <script>
    Chart.register(ChartZoom);

    function qsParam(name) {
      const v = new URLSearchParams(location.search).get(name);
      return v && /^\d+$/.test(v) ? v : null;
    }
    function setSearch(params) {
      const u = new URL(location);
      u.search = params.toString();
      location = u;
    }
    function flatten(obj, prefix = '', res = {}) {
      for (const [k, v] of Object.entries(obj || {})) {
        const key = prefix ? `${prefix}.${k}` : k;
        if (v != null && typeof v === 'object' && !Array.isArray(v)) {
          flatten(v, key, res);
        } else {
          res[key] = v;
        }
      }
      return res;
    }
    function humanize(f) {
      return f.replace(/[_\.]/g, ' ');
    }
    function makeSingleHTML(m) {
      const flat = flatten(m.Packet);
      let html = '<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
      Object.keys(flat).sort().forEach(k => {
        html += `<tr><td>${humanize(k)}</td><td>${flat[k]}</td></tr>`;
      });
      return html + '</tbody></table>';
    }

    // Sort configuration
    let sortConfig = { field: null, direction: 'asc' };

    // Build range table with sortable headers
    function makeRangeHTML(rows, fields) {
      let html = '<table><thead><tr>'
               + '<th class="sortable" data-field="Timestamp">Timestamp<span class="arrow"></span></th>';
      fields.forEach(f => {
        html += `<th class="sortable" data-field="${f}">${humanize(f)}<span class="arrow"></span></th>`;
      });
      html += '<th>Sentences</th></tr></thead><tbody>';
      rows.forEach((r,i) => {
        const flat = flatten(r.Packet);
        html += '<tr>'
             + `<td>${new Date(r.Timestamp).toLocaleString([], {
                  hour12:false,year:'numeric',month:'2-digit',
                  day:'2-digit',hour:'2-digit',minute:'2-digit',
                  second:'2-digit'})}</td>`;
        fields.forEach(f => {
          html += `<td>${flat[f]!=null?flat[f]:''}</td>`;
        });
        html += `<td><button class="view" data-i="${i}">View</button></td>`
             + '</tr>';
      });
      return html + '</tbody></table>';
    }
    function attachSortHandlers() {
      document.querySelectorAll('#range-table th.sortable').forEach(th=>{
        th.onclick = ()=>{
          const field = th.dataset.field;
          if (sortConfig.field === field) {
            sortConfig.direction = sortConfig.direction==='asc' ? 'desc' : 'asc';
          } else {
            sortConfig.field = field;
            sortConfig.direction = 'asc';
          }
          rangeData.sort((a,b)=>{
            const aV = field==='Timestamp'
              ? new Date(a.Timestamp).getTime()
              : Number(flatten(a.Packet)[field]);
            const bV = field==='Timestamp'
              ? new Date(b.Timestamp).getTime()
              : Number(flatten(b.Packet)[field]);
            return sortConfig.direction==='asc'? aV-bV : bV-aV;
          });
          document.querySelectorAll('#range-table .arrow').forEach(sp=>sp.textContent='');
          th.querySelector('.arrow').textContent = sortConfig.direction==='asc'? '▲':'▼';
          renderPage();
        };
      });
    }

    // CSV export helper
    function toCSV(rows, fields, includeRaw) {
      const header = ['Timestamp', ...fields];
      if (includeRaw) header.push('RawSentence');
      const lines = [header.join(',')];
      rows.forEach(r => {
        const flat = flatten(r.Packet),
              ts = new Date(r.Timestamp).toISOString(),
              vals = fields.map(f =>
                flat[f]!=null
                  ? `"${String(flat[f]).replace(/"/g,'""')}"`
                  : ''
              );
        if (includeRaw) {
          vals.push(`"${r.RawSentence.replace(/"/g,'""')}"`);
        }
        lines.push([ts, ...vals].join(','));
      });
      return lines.join('\n');
    }

    (async()=>{
      const userID     = qsParam('UserID'),
            msgID      = qsParam('MessageID'),
            errorEl    = document.getElementById('error'),
            mainTitle  = document.getElementById('main-title'),
            subTitle   = document.getElementById('sub-title'),
            typeDiv    = document.getElementById('type-selector'),
            typeSelect = document.getElementById('message-type-select'),
            startInput = document.getElementById('start'),
            endInput   = document.getElementById('end'),
            fieldsSel  = document.getElementById('fields'),
            resultsAs  = document.getElementById('results-as'),
            applyBtn   = document.getElementById('apply'),
            resetBtn   = document.getElementById('reset'),
            downloadRow= document.getElementById('download-row'),
            downloadBtn= document.getElementById('download-csv'),
            includeRaw = document.getElementById('include-raw'),
            pagination = document.getElementById('pagination-row'),
            viewInfo   = document.getElementById('view-info'),
            rowsSel    = document.getElementById('rows-per-page'),
            pagePrev   = document.getElementById('page-prev'),
            pageNext   = document.getElementById('page-next'),
            indDiv     = document.getElementById('individual-view'),
            rngDiv     = document.getElementById('range-view'),
            singleTbl  = document.getElementById('single-table'),
            singleRaw  = document.getElementById('single-raw'),
            prevBtn    = document.getElementById('prev'),
            nextBtn    = document.getElementById('next'),
            counterDiv = document.getElementById('counter'),
            rangeTbl   = document.getElementById('range-table'),
            chartCont  = document.getElementById('chart-container'),
            chartCanvas= document.getElementById('range-chart');

      if (!userID) {
        mainTitle.textContent='Error';
        errorEl.textContent='Missing UserID in URL.';
        return;
      }

      // Load summary
      try {
        const res = await fetch(`/summary?UserID=${userID}`,{cache:'no-store'}),
              sum = await res.json();
        mainTitle.textContent=`Latest Messages for ${sum[userID]?.Name.trim()||userID}`;
      } catch {
        mainTitle.textContent=`Latest Messages for ${userID}`;
      }

      // Load types selector
      let available=[]; try {
        const st = await (await fetch(`/state/${userID}`,{cache:'no-store'})).json();
        available = st.MessageTypes||[];
      } catch{}
      let typeMap={}; try {
        typeMap = await (await fetch('/message_types.json',{cache:'no-store'})).json();
      } catch{}
      available.forEach(t=>{
        const o=new Option(`${typeMap[t]||'Msg '+t} (ID ${t})`, t);
        if (`${t}`===msgID) o.selected=true;
        typeSelect.append(o);
      });
      if (available.length) {
        typeDiv.style.display='';
        typeSelect.onchange=()=>{
          setSearch(new URLSearchParams({UserID:userID,MessageID:typeSelect.value}));
        };
      }
      if (msgID) subTitle.textContent=`${typeMap[msgID]||'Message '+msgID} (ID ${msgID})`;

      // Fetch recent messages
      let allMsgs=[]; try {
        allMsgs = await (await fetch(`/latestmessages?UserID=${userID}&MessageID=${msgID}&limit=100`,{cache:'no-store'})).json();
      } catch {
        errorEl.textContent='Failed to load messages.';
        return;
      }
      if (!allMsgs.length) {
        errorEl.textContent='No messages found.';
        return;
      }

      // Populate numeric fields
      const baseFlat = flatten(allMsgs[0].Packet),
            numericFields = Object.entries(baseFlat).filter(([,v])=>typeof v==='number').map(([k])=>k).sort();
      numericFields.forEach(f=>{
        fieldsSel.append(new Option(humanize(f), f));
      });

      // Individual view
      let idx=0;
      function renderInd(){
        const m=allMsgs[idx];
        counterDiv.textContent=`${idx+1} of ${allMsgs.length}`;
        singleTbl.innerHTML=makeSingleHTML(m);
        singleRaw.textContent=m.RawSentence;
        prevBtn.disabled=idx===0;
        nextBtn.disabled=idx===allMsgs.length-1;
      }
      prevBtn.onclick=()=>{idx>0&&(idx--,renderInd())};
      nextBtn.onclick=()=>{idx<allMsgs.length-1&&(idx++,renderInd())};
      renderInd();

      // Range view state
      let rangeData=[], currentPage=1, rowsPerPage=parseInt(rowsSel.value,10), selectedFields=[];

      function renderPage(){
        const start=(currentPage-1)*rowsPerPage,
              end=Math.min(rangeData.length,start+rowsPerPage),
              pageRows=rangeData.slice(start,end);
        rangeTbl.innerHTML=makeRangeHTML(pageRows,selectedFields);
        attachSortHandlers();
        viewInfo.textContent=`Viewing ${start+1}–${end} of ${rangeData.length}`;
        pagePrev.disabled=currentPage===1;
        pageNext.disabled=end===rangeData.length;
        rangeTbl.querySelectorAll('button.view').forEach(btn=>{
          const i=+btn.dataset.i;
          btn.onclick=()=>alert(rangeData[start+i].RawSentence);
        });
      }

      rowsSel.onchange=()=>{
        rowsPerPage=parseInt(rowsSel.value,10);
        currentPage=1;
        renderPage();
      };
      pagePrev.onclick=()=>{ if(currentPage>1){currentPage--;renderPage()} };
      pageNext.onclick=()=>{ if(currentPage*rowsPerPage<rangeData.length){currentPage++;renderPage()} };

      // Show table vs graph
      function showTable(){
        chartCont.style.display='none';
        pagination.style.display='';
        renderPage();
      }
      function showGraph(){
        rangeTbl.style.display='none';
        pagination.style.display='none';
        chartCont.style.display='';
        // (chart logic unchanged...)
      }
      resultsAs.onchange=()=>{
        if (rngDiv.style.display!=='none') {
          resultsAs.value==='table'? showTable() : showGraph();
        }
      };

      // Apply search
      applyBtn.onclick=async()=>{
        const s=startInput.value, e=endInput.value;
        selectedFields=Array.from(fieldsSel.selectedOptions).map(o=>o.value);
        if(!s||!e||!selectedFields.length){
          return alert('Select From, To, and at least one field.');
        }
        const params=new URLSearchParams({
          UserID:userID,
          MessageID:msgID,
          start:new Date(s).toISOString(),
          end:new Date(e).toISOString(),
          limit:'2000'
        });
        try{
          rangeData=await (await fetch(`/latestmessages?${params}`,{cache:'no-store'})).json();
        }catch{
          return alert('Failed to fetch range.');
        }
        downloadBtn.onclick=()=>{
          const csv=toCSV(rangeData,selectedFields,includeRaw.checked),
                blob=new Blob([csv],{type:'text/csv'}),
                url=URL.createObjectURL(blob),
                a=document.createElement('a');
          a.href=url; a.download=`messages_${userID}_${msgID}.csv`; a.click(); URL.revokeObjectURL(url);
        };
        downloadRow.style.display='';
        indDiv.style.display='none';
        rngDiv.style.display='';
        resultsAs.value==='table'? showTable() : showGraph();
      };

      // Reset
      resetBtn.onclick=()=>{
        startInput.value='';
        endInput.value='';
        fieldsSel.selectedIndex=-1;
        downloadRow.style.display='none';
        pagination.style.display='none';
        rngDiv.style.display='none';
        indDiv.style.display='';
      };
    })();
  </script>
</body>
</html>
