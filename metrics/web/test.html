<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receiver Dashboard</title>

  <!-- Chart.js (optional, can be removed if not needed) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (optional, can be removed if not needed) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; cursor: pointer; }
    td a { color: #0066cc; text-decoration: none; }
    td a:hover { text-decoration: underline; }
    .input-group { margin-top: 20px; }
    .input-group input { padding: 5px; margin-right: 10px; }
  </style>
</head>
<body>
  <h2>Receiver Dashboard</h2>

  <!-- Input fields for IP Address and ID -->
  <div class="input-group">
    <label for="ip-address-input">IP Address:</label>
    <input type="text" id="ip-address-input" placeholder="Enter IP Address" />
    <label for="id-input">ID:</label>
    <input type="text" id="id-input" placeholder="Enter ID" />
    <button id="submitBtn">Request Metrics</button>
  </div>

  <h3>Current IP: <span id="ip-address">Loading...</span></h3>

  <table id="metricsTable">
    <thead>
      <tr>
        <th>Metric</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script src="/socket.io.min.js"></script>
  <script>
    // Connect to the Socket.IO server (client-side)
    const socket = io();  // Creates a Socket.IO connection

    // Request metrics by source (IP address or ID)
    function requestMetricsBySource(identifier, isIpAddress = true) {
      console.log(`Sending request for metrics with ${isIpAddress ? 'IP' : 'ID'}: ${identifier}`);
      const payload = isIpAddress ? { ipaddress: identifier } : { id: identifier };
      console.log("Sent Payload:", payload);
      
      // Emit the request to the server with the identifier (IP or ID)
      socket.emit("metrics/bysource", payload);
    }

    // Listen for incoming metrics data from the server
    socket.on("metrics/bysource", function(metricsData) {
      console.log("Received metrics data:", metricsData);

      // Log the entire response payload (data received from the server)
      console.log("Received Payload:", metricsData);

      // Update the table with the received data
      updateTable(metricsData);
    });

    // Function to update the table with the received metrics data
    function updateTable(metricsData) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';  // Clear the previous table rows

      // Render the aggregated data
      const aggregated = metricsData.aggregated || {};
      for (const [metric, value] of Object.entries(aggregated)) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${metric}</td><td>${value}</td>`;
        tableBody.appendChild(row);
      }

      // Render the simple metrics
      const simpleMetrics = metricsData.simple_metrics || {};
      for (const [metric, value] of Object.entries(simpleMetrics)) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${metric}</td><td>${value}</td>`;
        tableBody.appendChild(row);
      }

      // Render the requested_ip_address
      const row = document.createElement('tr');
      row.innerHTML = `<td>Requested IP Address</td><td>${metricsData.requested_ip_address}</td>`;
      tableBody.appendChild(row);

      // Render window_user_ids (if present) or display a message if null
      if (metricsData.window_user_ids) {
        metricsData.window_user_ids.forEach(uid => {
          const rowData = metricsData.window_user_data[uid] || {};
          const userRow = document.createElement('tr');
          userRow.innerHTML = `
            <td>User ID: ${uid}</td>
            <td>Name: ${rowData.Name || 'N/A'}, Type: ${rowData.Type || 'N/A'}, Status: ${rowData.Status || 'N/A'}, Last Seen: ${new Date(rowData.LastSeen).toLocaleString() || 'N/A'}
          `;
          tableBody.appendChild(userRow);
        });
      } else {
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = `<td colspan="2">No window user IDs available</td>`;
        tableBody.appendChild(noDataRow);
      }
    }

    // Event listener for submitting the request
    document.getElementById('submitBtn').addEventListener('click', function() {
      const ip = document.getElementById('ip-address-input').value;
      const id = document.getElementById('id-input').value;

      if (ip) {
        // Request metrics using IP address
        requestMetricsBySource(ip, true);
      } else if (id) {
        // Request metrics using ID
        requestMetricsBySource(id, false);
      } else {
        alert("Please enter either an IP address or an ID.");
      }
    });

    // Fetch the IP address once and use it for requests
    async function fetchIpAddressAndRequestMetrics() {
      try {
        const ipRes = await fetch('/myip');  // Fetch the IP address from the /myip endpoint
        if (!ipRes.ok) throw ipRes.status;

        const ipData = await ipRes.json();
        const ip = ipData.ip;  // Store the IP from the "ip" field in the response

        // Update the IP address on the page
        document.getElementById('ip-address').textContent = ip;

        // Request metrics with the fetched IP
        requestMetricsBySource(ip);
      } catch (e) {
        console.error('Error fetching IP address:', e);
      }
    }

    // Initialize by fetching the IP address and requesting metrics
    fetchIpAddressAndRequestMetrics();
  </script>
</body>
</html>
