<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receiver Dashboard</title>

  <!-- Chart.js (optional, can be removed if not needed) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (optional, can be removed if not needed) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; cursor: pointer; }
    td a { color: #0066cc; text-decoration: none; }
    td a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h2>IP Address: <span id="ip-address">Loading...</span></h2>
  
  <table id="metricsTable">
    <thead>
      <tr>
        <th>MMSI</th>
        <th>Name</th>
        <th>Type</th>
        <th>Status</th>
        <th>Last Seen</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script src="/socket.io.min.js"></script>
  <script>
    // Connect to the Socket.IO server (client-side)
    const socket = io();  // Creates a Socket.IO connection

    // Variable to store the fetched IP address
    let currentIp = null;

    // Request metrics by source (IP address)
    function requestMetricsBySource(ipaddress) {
      console.log(`Sending request for metrics with IP: ${ipaddress}`);
      // Emit the request to the server with the IP address
      socket.emit("metrics/bysource", { ipaddress: ipaddress });
    }

    // Listen for incoming metrics data from the server
    socket.on("metrics/bysource", function(metricsData) {
      console.log("Received metrics data:", metricsData);
      
      // Update the table with the received data
      updateTable(metricsData);
    });

    // Fetch the IP address once and use it for requests
    async function fetchIpAddressAndRequestMetrics() {
      try {
        const ipRes = await fetch('/myip');  // Fetch the IP address from the /myip endpoint
        if (!ipRes.ok) throw ipRes.status;

        const ipData = await ipRes.json();
        currentIp = ipData.ip;  // Store the IP from the "ip" field in the response

        // Update the IP address on the page
        document.getElementById('ip-address').textContent = currentIp;

        // Request metrics with the fetched IP
        requestMetricsBySource(currentIp);
      } catch (e) {
        console.error('Error fetching IP address:', e);
      }
    }

    // Function to update the table with the received metrics data
    function updateTable(metricsData) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';  // Clear the previous table rows

      metricsData.window_user_ids.forEach(uid => {
        const rowData = metricsData.window_user_data[uid];
        
        // Create a new table row
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${uid}</td>
          <td>${rowData.Name || 'N/A'}</td>
          <td>${rowData.Type || 'N/A'}</td>
          <td>${rowData.Status || 'N/A'}</td>
          <td>${new Date(rowData.LastSeen).toLocaleString() || 'N/A'}</td>
        `;

        // Append the new row to the table
        tableBody.appendChild(row);
      });
    }

    // Initialize by fetching the IP address and requesting metrics
    fetchIpAddressAndRequestMetrics();
  </script>
</body>
</html>
